#!/usr/bin/env raku


multi MAIN(Bool :l(:$list) = False) {
  qqx/git add . && git commit -m "n" && git push/ if $list == False;

  my @messages;

  my @repos = shell("find ~/ -type d -name '.git' -not -path '*/.source/*' -not -path '*/.antigen/*' -not -path '*/.cargo/*' -not -path '*/elpaca/*' -not -path '*/.cache/*' -not -path '*/.local/*' -not -path '*/.share/*' -printf '%p\n' 2>/dev/null", :out)
  .out.slurp(:close).lines.map(*.chomp); # Apply chomp to each line

  for @repos -> $repo-dir {
    my $status = shell("git -C {$repo-dir.IO.parent} status --porcelain", :out).out.slurp(:close);

    if $status.chars {
      my $last-commit-date = shell("git -C {$repo-dir.IO.parent} log -1 --format=%cd", :out)
      .out.slurp(:close).chomp;
      my $message = "\nRepository with uncommitted changes: {$repo-dir.IO.parent}\n"
      ~ "Last commit date: $last-commit-date";
      @messages.push($message);
    }
  }

  say @messages.join("\n");
  say "";
}


multi MAIN(Bool :a(:$all)!) {
  my @repos = shell("find ~/ -type d -name '.git' -not -path '*/.source/*' -not -path '*/.antigen/*' -not -path '*/.cargo/*' -not -path '*/elpaca/*' -not -path '*/.cache/*' -not -path '*/.local/*' -not -path '*/.share/*' -printf '%p\n' 2>/dev/null", :out)
  .out.slurp(:close).lines.map(*.chomp); # Apply chomp to each line

  for @repos -> $repo-dir {
    say "Processing: $repo-dir .."; # Inspect the path
    # qqx/cd "{$repo-dir}/.." && git add . && git commit -m "n" && git push/;
    qqx/cd "{$repo-dir.IO.dirname}" && git add . && git commit -m "n" && git push/;
    say "--------------------------------------------------------------------";
    }
}


# {$repo-dir.IO.dirname} - originally i go into a .git directory, with
# 'IO.dirname' i go to a directory of a .git directory instead.
